<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>AA GYM HALLOWEEN (Marker AR, Safari 호환)</title>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#0e0e0f; color:#fff; }
    body { font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif; }
    #gate { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:#0e0e0f; color:#fff; z-index:9999; text-align:center; padding:24px; }
    #gate button { margin-top:14px; padding:12px 16px; border:0; border-radius:12px; font-weight:800; font-size:16px;
      background:#fff; color:#111; box-shadow:0 6px 18px rgba(0,0,0,.35); }
    #previewWrap { margin-top:12px; display:none; }
    #preview { width:70vw; max-width:420px; border-radius:12px; background:#000; }
    #hint { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; padding:8px 12px;
      background:rgba(0,0,0,.5); color:#fff; border-radius:10px; font-weight:700; z-index:10; }
    a-scene { display:none; }
  </style>
</head>
<body>
  <div id="gate">
    <h1>카메라 권한이 필요합니다</h1>
    <p>Safari에서 여세요. (카톡/네이버 인앱 불가)</p>
    <button id="grantBtn">카메라 켜기</button>
    <div id="previewWrap">
      <p style="font-size:13px;">아래에 카메라 미리보기가 나오면 OK ▶ AR 시작하기</p>
      <video id="preview" playsinline autoplay muted></video>
      <button id="startAR" style="margin-top:10px; padding:10px 14px; border:0; border-radius:12px; font-weight:800;">AR 시작하기</button>
    </div>
    <p id="err" style="color:#ffb3b3; display:none; max-width:460px;"></p>
  </div>

  <div id="hint" hidden>포스터(마커 이미지)를 비추면 👻 유령이 나타납니다</div>

  <a-scene
    id="arscene"
    mindar-image="imageTargetSrc: https://raw.githubusercontent.com/hiukim/mind-ar-js/master/examples/image-tracking/assets/card-example/card.mind;"
    color-space="sRGB"
    renderer="antialias:true; colorManagement:true; physicallyCorrectLights:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true">
    <a-assets></a-assets>
    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity mindar-image-target="targetIndex:0">
      <a-entity id="ghost" position="0 0 0" scale="1 1 1">
        <a-sphere radius="0.18" color="#FFFFFF" position="0 0.25 0" opacity="0.97"></a-sphere>
        <a-cylinder radius="0.16" height="0.06" color="#FFFFFF" position="0 0.08 0" opacity="0.95"></a-cylinder>
        <a-cylinder radius="0.13" height="0.05" color="#FFFFFF" position="0 0.03 0" opacity="0.93"></a-cylinder>
        <a-cylinder radius="0.09" height="0.04" color="#FFFFFF" position="0 -0.01 0" opacity="0.90"></a-cylinder>
        <a-sphere radius="0.025" color="#111" position="-0.055 0.29 0.15"></a-sphere>
        <a-sphere radius="0.025" color="#111" position="0.055 0.29 0.15"></a-sphere>
        <a-cylinder radius="0.028" height="0.02" color="#111" position="0 0.245 0.16" rotation="90 0 0"></a-cylinder>
        <a-cylinder radius="0.015" height="0.5" color="#444" position="0 0.12 0" rotation="0 0 90"></a-cylinder>
        <a-torus radius="0.07" radius-tubular="0.02" color="#FF8C00" position="-0.25 0.12 0"></a-torus>
        <a-torus radius="0.07" radius-tubular="0.02" color="#FF8C00" position="0.25 0.12 0"></a-torus>
        <a-animation attribute="position" dur="1800" direction="alternate" repeat="indefinite" to="0 0.04 0"></a-animation>
        <a-animation attribute="rotation" dur="2600" direction="alternate" repeat="indefinite" to="0 10 0"></a-animation>
      </a-entity>
    </a-entity>

    <a-entity light="type:hemisphere; intensity:1.1"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0 1 0"></a-entity>
  </a-scene>

  <script>
    const gate=document.getElementById('gate');
    const grantBtn=document.getElementById('grantBtn');
    const previewWrap=document.getElementById('previewWrap');
    const preview=document.getElementById('preview');
    const startAR=document.getElementById('startAR');
    const hint=document.getElementById('hint');
    const arscene=document.getElementById('arscene');
    const err=document.getElementById('err');
    let previewStream=null;

    async function requestPreview(){
      err.style.display='none';
      try{
        previewStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        preview.srcObject=previewStream;
        previewWrap.style.display='block';
      }catch(e){
        err.textContent='❌ 카메라 권한 필요: 설정 > Safari > 카메라 > 허용';
        err.style.display='block';
      }
    }

    async function startARFlow(){
      try{
        if(previewStream){previewStream.getTracks().forEach(t=>t.stop());preview.srcObject=null;}
        gate.style.display='none';hint.hidden=false;arscene.style.display='block';
      }catch(e){err.textContent='AR 시작 중 오류: '+e.message;err.style.display='block';}
    }

    grantBtn.addEventListener('click',requestPreview);
    startAR.addEventListener('click',startARFlow);
  </script>
</body>
</html>
